<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.enjoytrip.domain.answer.mapper.AnswerMapper">

    <select id="answerInfo" parameterType="Long" resultType="Answer">
        SELECT * FROM answer WHERE answer_id = #{answerId}
    </select>

    <insert id="insertAnswer" parameterType="Answer" useGeneratedKeys="true" keyProperty="answerId">
        INSERT INTO answer (question_id, member_id, content, created_date, last_modified_date)
        VALUES (#{questionId}, #{memberId}, #{content}, #{createdDate}, #{lastModifiedDate})
    </insert>

    <delete id="deleteAnswer" parameterType="Long">
        <choose>
            <when test="isAdmin(memberId)">
                DELETE FROM answer WHERE answer_id = #{answerId};
                UPDATE question SET has_response = false WHERE question_id = (SELECT question_id FROM answer WHERE
                answer_id = #{answerId});
            </when>
            <otherwise>
                <!--삭제 조건 부합x-->
            </otherwise>
        </choose>
    </delete>

    <update id="updateAnswer" parameterType="Answer">
        UPDATE answer
        SET question_id = #{questionId}, member_id = #{memberId}, content = #{content}, last_modified_date =
        #{lastModifiedDate}
        WHERE answer_id = #{answerId}
    </update>

    <select id="isAdmin" parameterType="Long" resultType="int">
        SELECT COUNT(*) FROM roles WHERE member_id = #{memberId} AND role_name = 'ADMIN'
    </select>

    <select id="isAdminRole" parameterType="Long" resultType="boolean">
        SELECT COUNT(*) > 0 FROM roles WHERE member_id = #{memberId} AND role_name = 'ADMIN'
    </select>
</mapper>
